#   _____             __ _                       _   _                
#  / ____|           / _(_)                     | | (_)                
# | |     ___  _ __ | |_ _  __ _ _   _ _ __ __ _| |_ _  ___  _ __  ___ 
# | |    / _ \| '_ \|  _| |/ _` | | | | '__/ _` | __| |/ _ \| '_ \/ __|
# | |___| (_) | | | | | | | (_| | |_| | | | (_| | |_| | (_) | | | \__ \
#  \_____\___/|_| |_|_| |_|\__, |\__,_|_|  \__,_|\__|_|\___/|_| |_|___/
#                           __/ |                                      
#                          |___/    
#
# Klipper Configurations - Flsun V400
# Version 3.0
#
# Guislain Cyril


########################################
# Firmware Settings
########################################

# MKS Robin Nano V2.0

# When running "make menuconfig"
#
# [*] Enable extra low-level configuration options
#     Micro-controller Architecture (STMicroelectronics STM32)  --->
#     Processor model (STM32F103)  --->
# [ ] Only 10KiB of RAM (for rare stm32f103x6 variant)  (NEW)
# [ ] Disable SWD at startup (for GigaDevice stm32f103 clones)  (NEW)
#     Bootloader offset (28KiB bootloader)  --->
#     Clock Reference (8 MHz crystal)  --->
#     Communication interface (Serial (on USART3 PB11/PB10))  --->
# (250000) Baud rate for serial port
# ()  GPIO pins to set at micro-controller startup
#
# Note that the "make flash" command does not work with MKS Robin
# boards. After running "make", run the following command:
#   ./scripts/update_mks_robin.py out/klipper.bin out/Robin_nano35.bin
# Copy the file out/Robin_nano35.bin to an microSD card, 
# insert it in the printer and restart it.


########################################
# Editable Settings
########################################

# Notes: Some settings can be enabled or disabled by removing or adding the '#' symbol
#
# PID (pid_Kp, pid_Ki, pid_Kd) --> [extruder] and [heater_bed] sections
# E-Steps Extruder (rotation_distance) --> [extruder] section --> <rotation_distance> = <full_steps_per_rotation> * <microsteps> / <steps_per_mm>
# Pressure Advance (pressure_advance) --> [extruder] section -- See: https://www.klipper3d.org/Pressure_Advance.html
# Firmware Retraction --> [firmware_retraction] section -- Requires "Klipper Settings Plugin" for Cura -- See: https://github.com/jjgraphix/KlipperSettingsPlugin
# ADXL345 function for resonance testing --> Enable/Disable [include adxl345_pico.cfg], [include adxl345_fysetc.cfg] or [include adxl345_flsun.cfg] -- Configuration in [input_shaper] section -- See: https://www.klipper3d.org/Measuring_Resonances.html
# NeoPixels function --> Enable/Disable [include neopixels.cfg]
# Timelapse function --> Enable/Disable [include timelapse.cfg]


########################################
# Included Files
########################################

[include macros.cfg]
#[include adxl345_pico.cfg]  #Enable if you want to use ADXL with Rapsberry Pi Pico
#[include adxl345_fysetc.cfg]  #Enable if you want to use ADXL with Fysetc Portable Input Shaper
#[include adxl345_flsun.cfg]  #Enable if you want to use ADXL with FLSUN ADXL
[include timelapse.cfg]  #Enable if you want to use Timelapse
#[include neopixels.cfg]  #Enable if you want to use Neopixels


########################################
# Printer Settings
########################################

[printer]
kinematics: delta
max_velocity: 400
max_accel: 8000
max_accel_to_decel: 5000
square_corner_velocity: 5
max_z_velocity: 100
max_z_accel: 1500
minimum_z_position: -25
print_radius: 152
#delta_radius: 152


########################################
# X Stepper Motor & Driver Settings
########################################

[stepper_a]
step_pin: PE3
dir_pin: PE2
enable_pin: !PE4
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA15
homing_speed: 50
homing_retract_dist: 5.0
homing_retract_speed: 10
#angle: 210
#position_endstop: 415.0
#arm_length = 345.0

[tmc2209 stepper_a]
uart_pin: PD5
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Y Stepper Motor & Driver Settings
########################################

[stepper_b]
step_pin: PE0
dir_pin: PB9
enable_pin: !PE1
microsteps: 16
rotation_distance: 40
endstop_pin: ^PA12
#angle: 330

[tmc2209 stepper_b]
uart_pin: PD7
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Z Stepper Motor & Driver Settings
########################################

[stepper_c]
step_pin: PB5
dir_pin: PB4
enable_pin: !PB8
microsteps: 16
rotation_distance: 40
endstop_pin: ^PC4
#angle: 90

[tmc2209 stepper_c]
uart_pin: PD4
run_current: 1.5
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Extruder & Driver Settings
########################################

[extruder]
step_pin: PD6
dir_pin: !PD3
enable_pin: !PB3
microsteps: 16
#rotation_distance: 4.5
rotation_distance: 4.531
nozzle_diameter: 0.400
filament_diameter: 1.750
heater_pin: PC3
sensor_type: EPCOS 100K B57560G104F
sensor_pin: PC1
min_temp: -5
max_temp: 315
max_extrude_cross_section: 50
max_extrude_only_distance: 800
pressure_advance: 0.02
pressure_advance_smooth_time: 0.01
#control = pid
#pid_kp = 17.501
#pid_ki = 0.711
#pid_kd = 107.630

[tmc2209 extruder]
uart_pin: PD9
run_current: 0.900
hold_current: 0.5
stealthchop_threshold: 999999


########################################
# Bed Settings
########################################

[heater_bed]
heater_pin: PA0
sensor_pin: PC0
sensor_type: EPCOS 100K B57560G104F
min_temp: -5
max_temp: 120
#control = pid
#pid_kp = 64.044
#pid_ki = 3.812
#pid_kd = 268.984


########################################
# Filament Sensor Settings
########################################

[filament_switch_sensor filament_sensor]
pause_on_runout: True
runout_gcode: M600
switch_pin: PA4


########################################
# Fans Settings
########################################

[fan]
pin: PB1

[heater_fan Hotend] 
pin: PB0
heater_temp: 50.0


########################################
# Probe Settings
########################################

[probe]
pin: !PA11
x_offset: 0
y_offset: 0
#z_offset: 0
speed: 5
lift_speed: 10
samples: 7
samples_result: average
sample_retract_dist: 5
samples_tolerance: 0.015
samples_tolerance_retries: 10


########################################
# Delta Calibration & Mesh Settings
########################################

[delta_calibrate]
radius: 147
horizontal_move_z: 30
speed: 10

[bed_mesh]
speed: 5
horizontal_move_z: 30
mesh_radius: 147
mesh_origin: 0,0
mesh_pps: 0,0
round_probe_count: 23
algorithm: bicubic
bicubic_tension: 0.1
move_check_distance: 3
split_delta_z: .025
fade_start: 1
fade_end: 30 


########################################
# Temperature Controls
########################################

[verify_heater extruder]
max_error: 500
hysteresis: 20

[verify_heater heater_bed]
max_error: 120
hysteresis: 5


########################################
# Firmware Retraction Settings
########################################

[firmware_retraction]
#   The length of filament (in mm) to retract when G10 is activated,
#   and to unretract when G11 is activated (but see
#   unretract_extra_length below). The default is 0 mm.
retract_length: 0.7
#   The speed of retraction, in mm/s. The default is 20 mm/s.
retract_speed: 40
#   The length (in mm) of *additional* filament to add when
#   unretracting.
unretract_extra_length: 0.05
#   The speed of unretraction, in mm/s. The default is 10 mm/s.
unretract_speed: 40

########################################
# Input Shaper Settings
########################################

[input_shaper]
shaper_freq_x: 48.4
shaper_type_x = mzv
shaper_freq_y: 51.2
shaper_type_y = mzv


########################################
# G-Code Macros & Events
########################################

[idle_timeout]
timeout: 1800

[save_variables]
filename: ~/printer_data/config/variables.cfg

[gcode_arcs]
resolution: 0.1

[pause_resume]

[display_status]

[respond]

[exclude_object]

[virtual_sdcard]
path: ~/printer_data/gcodes

[endstop_phase stepper_a]
endstop_align_zero: false

[endstop_phase stepper_b]
endstop_align_zero: false

[endstop_phase stepper_c]
endstop_align_zero: false 


########################################
# MCU Settings
########################################

[mcu]
serial: /dev/serial/by-id/usb-1a86_USB_Serial-if00-port0
restart_method: command

[temperature_sensor Speeder_Pad]
sensor_type: temperature_host
min_temp: 10
max_temp: 100

[temperature_sensor Motherboard]
sensor_type: temperature_mcu
min_temp: 0
max_temp: 100


########################################
# LED Settings
########################################

[output_pin LED_Hotend]
pin: PE12
pwm: False
value: 0

[output_pin LED_Logo]
pin: PD11
pwm: False
value: 1

[neopixel NeoPixels]
pin: PB2
chain_count: 34
color_order: GRB
initial_RED: 0.0
initial_GREEN: 0.0
initial_BLUE: 0.0

#*# <---------------------- SAVE_CONFIG ---------------------->
#*# DO NOT EDIT THIS BLOCK OR BELOW. The contents are auto-generated.
#*#
#*# [probe]
#*# z_offset = 18.175
#*#
#*# [printer]
#*# delta_radius = 161.820563
#*#
#*# [stepper_a]
#*# angle = 210.012149
#*# arm_length = 344.106553
#*# position_endstop = 420.140294
#*#
#*# [stepper_b]
#*# angle = 329.876290
#*# arm_length = 344.039860
#*# position_endstop = 420.966479
#*#
#*# [stepper_c]
#*# angle = 90.000000
#*# arm_length = 344.490513
#*# position_endstop = 419.572988
#*#
#*# [bed_mesh default]
#*# version = 1
#*# points =
#*# 	  -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887, -0.147887
#*# 	  -0.216592, -0.216592, -0.216592, -0.216592, -0.216592, -0.216592, -0.216592, -0.216592, -0.190928, -0.156663, -0.161276, -0.135818, -0.110233, -0.097058, -0.090755, -0.050183, -0.050183, -0.050183, -0.050183, -0.050183, -0.050183, -0.050183, -0.050183
#*# 	  -0.181077, -0.181077, -0.181077, -0.181077, -0.181077, -0.181077, -0.201784, -0.177168, -0.158431, -0.141155, -0.121975, -0.106209, -0.077862, -0.028948, -0.026009, -0.025701, -0.005567, 0.004821, 0.004821, 0.004821, 0.004821, 0.004821, 0.004821
#*# 	  -0.161593, -0.161593, -0.161593, -0.161593, -0.161593, -0.137076, -0.160851, -0.155724, -0.114237, -0.101536, -0.090641, -0.084213, -0.062361, -0.073222, -0.074273, -0.069522, -0.052299, -0.031695, -0.029495, -0.029495, -0.029495, -0.029495, -0.029495
#*# 	  -0.131797, -0.131797, -0.131797, -0.131797, -0.144898, -0.174613, -0.135108, -0.142277, -0.100450, -0.099233, -0.075643, -0.071809, -0.044055, -0.058129, -0.029339, -0.046947, -0.003034, 0.007390, -0.010875, -0.037512, -0.037512, -0.037512, -0.037512
#*# 	  -0.082755, -0.082755, -0.082755, -0.084159, -0.075070, -0.097896, -0.079496, -0.061880, -0.044333, -0.057618, -0.070621, -0.055346, -0.035343, -0.028864, -0.056469, -0.043003, -0.039234, -0.055830, -0.091420, -0.132916, -0.100174, -0.100174, -0.100174
#*# 	  -0.094065, -0.094065, -0.094065, -0.108718, -0.108940, -0.103946, -0.097721, -0.092264, -0.048815, -0.074968, -0.082933, -0.061585, -0.014558, -0.012329, -0.010929, -0.051111, -0.036058, -0.027237, -0.055668, -0.080801, -0.074668, -0.074668, -0.074668
#*# 	  -0.009912, -0.009912, -0.081363, -0.068602, -0.052135, -0.075948, -0.058726, -0.048510, -0.057481, -0.020477, -0.053543, -0.049262, -0.028078, -0.039103, -0.043350, -0.049529, -0.036486, -0.071665, -0.127923, -0.145867, -0.177185, -0.183993, -0.183993
#*# 	  -0.099549, -0.099549, -0.121176, -0.103424, -0.097399, -0.097741, -0.106647, -0.089968, -0.079284, -0.047028, -0.065245, -0.055600, -0.028325, -0.024639, -0.052864, -0.033681, -0.022572, 0.010741, -0.075502, -0.099805, -0.090915, -0.164529, -0.164529
#*# 	  -0.047682, -0.047682, -0.040298, -0.030230, -0.048733, -0.058068, -0.046377, -0.048060, -0.040293, -0.016945, -0.048128, -0.036729, -0.054162, -0.032571, -0.044132, -0.061462, -0.074749, -0.080587, -0.097588, -0.159608, -0.187971, -0.200649, -0.200649
#*# 	  -0.057309, -0.057309, -0.089339, -0.055564, -0.079629, -0.081053, -0.086030, -0.094353, -0.055190, -0.072180, -0.056358, -0.035164, -0.051445, -0.032197, -0.034391, -0.033206, -0.031158, -0.042676, -0.070631, -0.094334, -0.111299, -0.154512, -0.154512
#*# 	  -0.035615, -0.045666, -0.056093, -0.062217, -0.053128, -0.036167, -0.063495, -0.068733, -0.022527, -0.039290, -0.063301, -0.051388, -0.033470, -0.049066, -0.065739, -0.056277, -0.063789, -0.074865, -0.092806, -0.126791, -0.160260, -0.208196, -0.184567
#*# 	  -0.104367, -0.104367, -0.124149, -0.122784, -0.092098, -0.110999, -0.111757, -0.086522, -0.073661, -0.047148, -0.047080, -0.018955, -0.004583, -0.047678, -0.038306, -0.021621, -0.001081, -0.035463, -0.042029, -0.065821, -0.101992, -0.165474, -0.165474
#*# 	  -0.075083, -0.075083, -0.090873, -0.071639, -0.086449, -0.097006, -0.082013, -0.052311, -0.022261, -0.045517, -0.041768, -0.052052, -0.045614, -0.058396, -0.050167, -0.054926, -0.064829, -0.077056, -0.115006, -0.145623, -0.164138, -0.185189, -0.185189
#*# 	  -0.110972, -0.110972, -0.151129, -0.149758, -0.141941, -0.082693, -0.097992, -0.104411, -0.084325, -0.078843, -0.070175, -0.036321, -0.030489, -0.037286, -0.056279, -0.034948, -0.052760, -0.041978, -0.045453, -0.084424, -0.119151, -0.185878, -0.185878
#*# 	  -0.142951, -0.142951, -0.098944, -0.119735, -0.114022, -0.108428, -0.120282, -0.085659, -0.066116, -0.051105, -0.065628, -0.055686, -0.038627, -0.025276, -0.041882, -0.029675, -0.039290, -0.074889, -0.099364, -0.118941, -0.144604, -0.181159, -0.181159
#*# 	  -0.182420, -0.182420, -0.182420, -0.191930, -0.154844, -0.138886, -0.140881, -0.108966, -0.075586, -0.059447, -0.061269, -0.043006, -0.021287, -0.011360, -0.032597, -0.027162, -0.038326, -0.035769, -0.067562, -0.086140, -0.125751, -0.125751, -0.125751
#*# 	  -0.191797, -0.191797, -0.191797, -0.152387, -0.152432, -0.145189, -0.135058, -0.102812, -0.094200, -0.063765, -0.064860, -0.031852, -0.001257, -0.001270, -0.023945, -0.041903, -0.052982, -0.051512, -0.079210, -0.126378, -0.116159, -0.116159, -0.116159
#*# 	  -0.235694, -0.235694, -0.235694, -0.235694, -0.239314, -0.206931, -0.165208, -0.143982, -0.125027, -0.102960, -0.075308, -0.062664, -0.023729, -0.026646, -0.025818, -0.047127, -0.030060, -0.022811, -0.064571, -0.101734, -0.101734, -0.101734, -0.101734
#*# 	  -0.242107, -0.242107, -0.242107, -0.242107, -0.242107, -0.216520, -0.183761, -0.165118, -0.127684, -0.089383, -0.115592, -0.065648, -0.028690, -0.023122, -0.034871, -0.055219, -0.024905, -0.045182, -0.077491, -0.077491, -0.077491, -0.077491, -0.077491
#*# 	  -0.247984, -0.247984, -0.247984, -0.247984, -0.247984, -0.247984, -0.243381, -0.205397, -0.137467, -0.099763, -0.082347, -0.086733, -0.037816, -0.012471, -0.011943, -0.031172, -0.013170, -0.029463, -0.029463, -0.029463, -0.029463, -0.029463, -0.029463
#*# 	  -0.249569, -0.249569, -0.249569, -0.249569, -0.249569, -0.249569, -0.249569, -0.249569, -0.169677, -0.127859, -0.073366, -0.090142, -0.019163, -0.002986, -0.033566, -0.022273, -0.022273, -0.022273, -0.022273, -0.022273, -0.022273, -0.022273, -0.022273
#*# 	  -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962, -0.078962
#*# tension = 0.1
#*# min_x = -146.96
#*# algo = bicubic
#*# y_count = 23
#*# mesh_y_pps = 0
#*# min_y = -146.96
#*# x_count = 23
#*# max_y = 146.96
#*# mesh_x_pps = 0
#*# max_x = 146.96
#*#
#*# [heater_bed]
#*# control = pid
#*# pid_kp = 73.959
#*# pid_ki = 2.770
#*# pid_kd = 493.676
#*#
#*# [extruder]
#*# control = pid
#*# pid_kp = 19.635
#*# pid_ki = 0.949
#*# pid_kd = 101.613
#*#
#*# [endstop_phase stepper_a]
#*# trigger_phase = 5/64
#*#
#*# [endstop_phase stepper_b]
#*# trigger_phase = 63/64
#*#
#*# [endstop_phase stepper_c]
#*# trigger_phase = 49/64
#*#
#*# [delta_calibrate]
#*# height0 = 18.175
#*# height0_pos = 32149.000,32225.286,32111.714
#*# height1 = 18.175
#*# height1_pos = 38548.286,38634.286,28935.429
#*# height2 = 18.175
#*# height2_pos = 31652.000,42262.000,31612.000
#*# height3 = 18.175
#*# height3_pos = 29079.143,37525.000,37412.000
#*# height4 = 18.175
#*# height4_pos = 31366.000,31436.000,38817.000
#*# height5 = 18.175
#*# height5_pos = 36490.000,29299.143,36444.143
#*# height6 = 18.175
#*# height6_pos = 40397.714,31562.143,31439.714
#*# distance0 = 64.98
#*# distance0_pos1 = 33427.089,33775.562,33661.031
#*# distance0_pos2 = 31387.464,35888.286,35777.663
#*# distance1 = 65.0
#*# distance1_pos1 = 33522.616,33583.568,33757.367
#*# distance1_pos2 = 32783.239,32837.129,37469.455
#*# distance2 = 64.98
#*# distance2_pos1 = 33714.862,33488.734,33661.031
#*# distance2_pos2 = 35839.766,31451.498,35777.663
#*# distance3 = 65.08
#*# distance3_pos1 = 33811.591,33584.768,33469.501
#*# distance3_pos2 = 37540.361,32855.119,32733.186
#*# distance4 = 65.03
#*# distance4_pos1 = 33714.921,33776.772,33374.297
#*# distance4_pos2 = 35840.768,35908.768,31341.576
#*# distance5 = 64.98
#*# distance5_pos1 = 33522.674,33872.741,33469.501
#*# distance5_pos2 = 32784.119,37595.748,32733.186
#*# distance6 = 65.04
#*# distance6_pos1 = 31545.840,35449.148,35651.007
#*# distance6_pos2 = 32932.175,32707.982,37310.149
#*# distance7 = 65.08
#*# distance7_pos1 = 32950.550,32726.677,36995.181
#*# distance7_pos2 = 35903.183,31504.690,35526.057
#*# distance8 = 65.1
#*# distance8_pos1 = 35712.607,31610.284,35338.950
#*# distance8_pos2 = 37380.249,33003.931,32603.708
#*# distance9 = 65.09
#*# distance9_pos1 = 37063.657,33021.675,32621.789
#*# distance9_pos2 = 35588.030,35971.418,31394.107
#*# distance10 = 65.05
#*# distance10_pos1 = 35400.066,35780.360,31499.482
#*# distance10_pos2 = 32654.160,37435.179,32881.603
#*# distance11 = 65.18
#*# distance11_pos1 = 32672.276,37119.159,32899.885
#*# distance11_pos2 = 31440.132,35636.059,35840.763
